const WebSocket = require('ws');
const http = require('http');
const { v4: uuidv4 } = require('uuid');

const PORT = process.env.PORT || 10000;

// Cr√©er un serveur HTTP pour g√©rer les requ√™tes WebSocket
const server = http.createServer((req, res) => {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('Serveur WebSocket actif\n');
});

// Cr√©er un serveur WebSocket
const wss = new WebSocket.Server({ server });

// Stockage des clients par type
const clients = {
    android: null,
    espCam: null,
    espStandard: null
};

// File d'attente pour les photos non envoy√©es √† l'application Android
const photoQueue = [];

// Statut des ESP
let espCamConnected = false;
let espStandardConnected = false;

function broadcastEspStatus() {
    if (clients.android && clients.android.readyState === WebSocket.OPEN) {
        const statusMessage = {
            type: 'esp_status',
            espCam: espCamConnected,
            espStandard: espStandardConnected
        };
        clients.android.send(JSON.stringify(statusMessage));
        console.log(`Message envoy√© √† Android: ${JSON.stringify(statusMessage)}`);
    }
}

function sendToEspStandard(message) {
    if (clients.espStandard && clients.espStandard.readyState === WebSocket.OPEN) {
        clients.espStandard.send(JSON.stringify(message));
        console.log(`Message envoy√© √† ESP-Standard: ${JSON.stringify(message)}`);
    }
}

wss.on('connection', (socket, req) => {
    const clientId = uuidv4();
    socket.clientId = clientId;
    socket.clientType = null;
    const clientIp = req.socket.remoteAddress;
    console.log(`üîó Nouveau client connect√© depuis ${clientIp} (ID: ${clientId}, Port: ${req.socket.remotePort})`);

    // Timeout pour l'enregistrement (30s pour tol√©rer les d√©lais r√©seau)
    const registrationTimeout = setTimeout(() => {
        if (!socket.clientType) {
            console.log(`Client ${clientId} non enregistr√© apr√®s 30s, fermeture connexion`);
            socket.send(JSON.stringify({ type: 'error', message: 'Enregistrement requis' }));
            socket.close(1000, 'Enregistrement requis');
        }
    }, 30000);

    socket.on('message', (data) => {
        try {
            // V√©rifier si les donn√©es sont binaires
            if (Buffer.isBuffer(data)) {
                if (!socket.clientType) {
                    console.log(`Donn√©es binaires re√ßues avant enregistrement (ID: ${clientId}), taille: ${data.length} bytes`);
                    socket.send(JSON.stringify({ type: 'error', message: 'Enregistrement requis avant envoi de donn√©es binaires' }));
                    return;
                }
                if (socket.clientType === 'esp32-cam') {
                    console.log(`Photo re√ßue de ESP-CAM (ID: ${clientId}), taille: ${data.length} bytes`);
                    // Transf√©rer √† l'application Android si connect√©e
                    if (clients.android && clients.android.readyState === WebSocket.OPEN) {
                        clients.android.send(data);
                        console.log(`Photo transf√©r√©e √† Android (ID: ${clients.android.clientId})`);
                    } else {
                        // Mettre en file d'attente si Android non connect√©
                        photoQueue.push(data);
                        console.log(`Android non connect√©, photo mise en file d'attente (taille: ${data.length} bytes)`);
                    }
                    // Envoyer commande pour allumer la lampe √† ESP-Standard
                    sendToEspStandard({ type: 'turn_on_light' });
                }
                return;
            }

            // Traiter les messages JSON
            const message = JSON.parse(data.toString());
            console.log(`Message JSON re√ßu de ${socket.clientType || 'Unknown'} (ID: ${clientId}): ${JSON.stringify(message)}`);

            if (message.type === 'register') {
                clearTimeout(registrationTimeout);
                const device = message.device;
                socket.clientType = device;

                if (device === 'android') {
                    clients.android = socket;
                    console.log('‚úÖ Android connect√©');
                    socket.send(JSON.stringify({ type: 'registered', message: 'Enregistrement r√©ussi' }));
                    // Envoyer le statut des ESP
                    broadcastEspStatus();
                    // Envoyer les photos en file d'attente
                    while (photoQueue.length > 0) {
                        const photo = photoQueue.shift();
                        socket.send(photo);
                        console.log(`Photo en file d'attente envoy√©e √† Android (taille: ${photo.length} bytes)`);
                    }
                } else if (device === 'esp32-cam') {
                    clients.espCam = socket;
                    espCamConnected = true;
                    console.log('‚úÖ ESP32-CAM connect√©');
                    socket.send(JSON.stringify({ type: 'registered', message: 'Enregistrement r√©ussi' }));
                    broadcastEspStatus();
                } else if (device === 'esp32-standard') {
                    clients.espStandard = socket;
                    espStandardConnected = true;
                    console.log('‚úÖ ESP32-Standard connect√©');
                    socket.send(JSON.stringify({ type: 'registered', message: 'Enregistrement r√©ussi' }));
                    broadcastEspStatus();
                } else {
                    console.log(`Type de dispositif inconnu: ${device}`);
                    socket.send(JSON.stringify({ type: 'error', message: 'Type de dispositif inconnu' }));
                    socket.close(1000, 'Type de dispositif inconnu');
                }
            } else if (!socket.clientType) {
                console.log(`Message JSON re√ßu avant enregistrement (ID: ${clientId}): ${JSON.stringify(message)}`);
                socket.send(JSON.stringify({ type: 'error', message: 'Enregistrement requis avant envoi de messages' }));
            } else if (message.type === 'alert' && (socket.clientType === 'esp32-cam' || socket.clientType === 'esp32-standard')) {
                console.log(`Alerte re√ßue de ${socket.clientType} (ID: ${clientId}): ${message.message}`);
                // Transf√©rer √† l'application Android
                if (clients.android && clients.android.readyState === WebSocket.OPEN) {
                    clients.android.send(JSON.stringify(message));
                    console.log(`Alerte transf√©r√©e √† Android (ID: ${clients.android.clientId})`);
                }
                // Envoyer commande pour allumer la lampe √† ESP-Standard
                sendToEspStandard({ type: 'turn_on_light' });
            } else if (message.type === 'network_config' && socket.clientType === 'android') {
                console.log(`Commande network_config re√ßue de Android (ID: ${clientId}): ${JSON.stringify(message.params)}`);
                // Transf√©rer √† ESP32-CAM et ESP32-Standard
                if (clients.espCam && clients.espCam.readyState === WebSocket.OPEN) {
                    clients.espCam.send(JSON.stringify(message));
                    console.log(`Commande network_config envoy√©e √† ESP-CAM (ID: ${clients.espCam.clientId})`);
                }
                if (clients.espStandard && clients.espStandard.readyState === WebSocket.OPEN) {
                    clients.espStandard.send(JSON.stringify(message));
                    console.log(`Commande network_config envoy√©e √† ESP-Standard (ID: ${clients.espStandard.clientId})`);
                }
                // Confirmer √† l'application Android
                socket.send(JSON.stringify({
                    type: 'command_response',
                    success: true,
                    message: 'network_config envoy√©. CAM: ' + (clients.espCam ? 'Queue' : 'Non connect√©') + ', STD: ' + (clients.espStandard ? 'Queue' : 'Non connect√©')
                }));
            } else if (message.type === 'security_config' && socket.clientType === 'android') {
                console.log(`Commande security_config re√ßue de Android (ID: ${clientId}): ${JSON.stringify(message.params)}`);
                // Transf√©rer √† ESP32-CAM et ESP32-Standard
                if (clients.espCam && clients.espCam.readyState === WebSocket.OPEN) {
                    clients.espCam.send(JSON.stringify(message));
                    console.log(`Commande security_config envoy√©e √† ESP-CAM (ID: ${clients.espCam.clientId})`);
                }
                if (clients.espStandard && clients.espStandard.readyState === WebSocket.OPEN) {
                    clients.espStandard.send(JSON.stringify(message));
                    console.log(`Commande security_config envoy√©e √† ESP-Standard (ID: ${clients.espStandard.clientId})`);
                }
                // Confirmer √† l'application Android
                socket.send(JSON.stringify({
                    type: 'command_response',
                    success: true,
                    message: 'security_config envoy√©. CAM: ' + (clients.espCam ? 'Queue' : 'Non connect√©') + ', STD: ' + (clients.espStandard ? 'Queue' : 'Non connect√©')
                }));
            } else if (message.type === 'ping') {
                socket.send(JSON.stringify({ type: 'pong' }));
                console.log(`Pong envoy√© √† ${socket.clientType} (ID: ${clientId})`);
            } else {
                console.log(`Message non g√©r√© de ${socket.clientType} (ID: ${clientId}): ${JSON.stringify(message)}`);
                socket.send(JSON.stringify({ type: 'error', message: 'Type de message inconnu' }));
            }
        } catch (error) {
            console.error(`Erreur traitement message (ID: ${clientId}):`, error);
            socket.send(JSON.stringify({ type: 'error', message: 'Erreur serveur: ' + error.message }));
        }
    });

    socket.on('close', (code, reason) => {
        console.log(`Client d√©connect√© (ID: ${clientId}, Type: ${socket.clientType || 'Unknown'}, Code: ${code}, Raison: ${reason.toString()})`);
        if (socket.clientType === 'android') {
            clients.android = null;
        } else if (socket.clientType === 'esp32-cam') {
            clients.espCam = null;
            espCamConnected = false;
            broadcastEspStatus();
        } else if (socket.clientType === 'esp32-standard') {
            clients.espStandard = null;
            espStandardConnected = false;
            broadcastEspStatus();
        }
        clearTimeout(registrationTimeout);
    });

    socket.on('error', (error) => {
        console.error(`Erreur WebSocket (ID: ${clientId}):`, error);
    });
});

// Lancer le serveur
server.listen(PORT, () => {
    console.log(`üöÄ Serveur actif sur port ${PORT}. √âcoute HTTP et WS.`);
});
